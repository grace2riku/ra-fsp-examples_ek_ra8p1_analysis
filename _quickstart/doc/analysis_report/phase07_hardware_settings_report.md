# Phase 7: ハードウェア設定 - 解析レポート

## 解析日時
2026-01-25

## 概要

EK-RA8P1 クイックスタートプロジェクトのハードウェア設定を解析しました。
クロック、ピン、ペリフェラルの設定を詳細に調査し、システム構成を明確化しました。

---

## 1. クロック設定

### 1.1 システムクロック構成

| クロック | 周波数 | 用途 |
|----------|--------|------|
| **ICLK** | 1000 MHz | CPUコア（Cortex-M85） |
| **PCLKA** | 200 MHz | 高速ペリフェラル |
| **PCLKB** | 100 MHz | 中速ペリフェラル |
| **PCLKC** | 100 MHz | ペリフェラル |
| **PCLKD** | 200 MHz | ペリフェラル |
| **PCLKE** | 100 MHz | ペリフェラル |
| **FCLK** | 100 MHz | Flash |
| **BCLK** | 200 MHz | 外部バス（SDRAM） |
| **SDCLK** | 200 MHz | SDRAM |
| **CKIO** | 100 MHz | 外部クロック出力 |

### 1.2 PLL設定

#### PLL1（メインPLL）

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| ソース | XTAL (24 MHz) | メイン発振器 |
| 乗数 | 250 | 周波数逓倍 |
| 分周比P | 3 | PLL出力分周 |
| 分周比Q | 2 | 代替出力分周 |
| 分周比R | 2 | 代替出力分周 |
| **出力周波数** | **2000 MHz** | 24MHz × 250 / 3 |
| **ICLK** | **1000 MHz** | PLL出力 / 2 |

#### PLL2（ペリフェラルPLL）

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| ソース | XTAL (24 MHz) | メイン発振器 |
| 乗数 | 120 | 周波数逓倍 |
| 分周比P | 5 | PLL出力分周 |
| 分周比Q | 6 | 代替出力分周 |
| 分周比R | 3 | 代替出力分周 |
| **出力周波数** | **576 MHz** | 24MHz × 120 / 5 |

### 1.3 クロック系統図

```
XTAL (24 MHz)
    │
    ├──→ PLL1 (×250/3 = 2000 MHz)
    │       │
    │       ├──→ /2 → ICLK (1000 MHz) → CPU Core
    │       ├──→ /10 → PCLKA (200 MHz)
    │       ├──→ /20 → PCLKB (100 MHz)
    │       ├──→ /20 → PCLKC (100 MHz)
    │       ├──→ /10 → PCLKD (200 MHz)
    │       ├──→ /20 → PCLKE (100 MHz)
    │       ├──→ /10 → BCLK (200 MHz) → SDRAM
    │       └──→ /20 → FCLK (100 MHz) → Flash
    │
    └──→ PLL2 (×120/5 = 576 MHz)
            │
            └──→ GLCDC, CEU, MIPI用クロック
```

---

## 2. ピン設定

### 2.1 ピン使用サマリー

| 機能 | ピン数 | 主要ピン |
|------|--------|----------|
| GLCDC（LCD） | 27 | P00-P07, P10-P17, P20-P27, P30-P32 |
| SDRAM | 51 | PA0-PA15, PB0-PB15, PC0-PC15, PD0-PD2 |
| MIPI-CSI | 6 | P400-P405 |
| I2C | 4 | P505-P506 (IIC1), P512-P511 |
| SCI | 4 | P609-P612 |
| GPT（PWM） | 4 | P109, P113, P812, P905 |
| IRQ（外部割込み） | 4 | P506, P504, P610, P905 |
| ADC | 2 | P006, P014 |

### 2.2 LCD (GLCDC) ピン配置

| 信号グループ | ピン | 機能 |
|--------------|------|------|
| LCD_DATA0-7 | P00-P07 | データビット0-7（青） |
| LCD_DATA8-15 | P10-P17 | データビット8-15（緑） |
| LCD_DATA16-23 | P20-P27 | データビット16-23（赤） |
| LCD_CLK | P30 | ピクセルクロック |
| LCD_TCON0 | P31 | 水平同期（HSYNC） |
| LCD_TCON2 | P32 | 垂直同期（VSYNC） |
| LCD_TCON3 | P33 | データイネーブル（DE） |

### 2.3 SDRAM ピン配置

| 信号グループ | ピン | 機能 |
|--------------|------|------|
| A0-A15 | PA0-PA15 | アドレスバス |
| D0-D15 | PB0-PB15 | データバス（16ビット） |
| CS#, RAS#, CAS#, WE# | PC0-PC3 | 制御信号 |
| CKE, CLK | PC4-PC5 | クロック関連 |
| DQM0-1 | PC6-PC7 | データマスク |

### 2.4 MIPI-CSI ピン配置

| ピン | 信号 | 機能 |
|------|------|------|
| P400 | MIPI_DSI_CK_P | クロック正相 |
| P401 | MIPI_DSI_CK_N | クロック逆相 |
| P402 | MIPI_DSI_D0_P | データレーン0正相 |
| P403 | MIPI_DSI_D0_N | データレーン0逆相 |
| P404 | MIPI_DSI_D1_P | データレーン1正相 |
| P405 | MIPI_DSI_D1_N | データレーン1逆相 |

---

## 3. GLCDC（グラフィックLCDコントローラ）設定

### 3.1 ディスプレイパラメータ

| 項目 | 値 | 説明 |
|------|-----|------|
| **解像度** | 1024 × 600 | 水平 × 垂直 |
| **色深度** | RGB888 (24bit) | True Color |
| **ピクセルクロック** | 51.2 MHz | フレームレートに依存 |
| **フレームバッファ** | 2面 | ダブルバッファリング |
| **レイヤー数** | 2 | Graphics Layer 1 & 2 |

### 3.2 タイミングパラメータ

| タイミング | 値 |
|------------|-----|
| 水平同期幅（HSW） | 120 ピクセル |
| 水平バックポーチ（HBP） | 32 ピクセル |
| 水平フロントポーチ（HFP） | 64 ピクセル |
| 垂直同期幅（VSW） | 10 ライン |
| 垂直バックポーチ（VBP） | 10 ライン |
| 垂直フロントポーチ（VFP） | 10 ライン |
| **総水平ピクセル** | 1240 ピクセル |
| **総垂直ライン** | 630 ライン |

### 3.3 レイヤー設定

| レイヤー | フォーマット | サイズ | 用途 |
|----------|--------------|--------|------|
| Layer 1 | RGB888 | 1024×600 | メイン画面 |
| Layer 2 | RGB888 | 1024×600 | オーバーレイ |

### 3.4 出力設定

| 項目 | 値 |
|------|-----|
| 出力フォーマット | 24ビットRGB |
| 出力インターフェース | パラレルRGB |
| 同期方式 | DE同期 |
| 信号極性 | CLK: 反転なし, HSYNC: 負極性, VSYNC: 負極性, DE: 正極性 |

---

## 4. MIPI-CSI / カメラ設定

### 4.1 MIPI-CSI設定

| 項目 | 値 | 説明 |
|------|-----|------|
| **レーン数** | 2 | デュアルレーン |
| **ビットレート** | 1000 Mbps | 高速シリアル通信 |
| **データフォーマット** | YUV422 | カメラ入力形式 |
| **仮想チャネル** | VC0 | 単一チャネル使用 |

### 4.2 CEU（キャプチャエンジンユニット）設定

| 項目 | 値 |
|------|-----|
| 入力フォーマット | YUV422 |
| キャプチャサイズ | 800×480（推定） |
| バッファ方式 | ダブルバッファ |
| 割込み | フレーム完了割込み有効 |

### 4.3 カメラモジュール（OV5640）

| 項目 | 値 |
|------|-----|
| センサー | OV5640 (5MP CMOS) |
| 接続方式 | MIPI-CSI2 |
| 解像度 | 最大2592×1944 |
| 出力フォーマット | YUV422, RGB565, RAW |
| XCLK | 24 MHz（GPT5で生成） |

---

## 5. I2C設定

### 5.1 IIC1（タッチパネル/カメラ制御）

| 項目 | 値 |
|------|-----|
| チャネル | IIC1 |
| ピン（SDA） | P505 |
| ピン（SCL） | P506 |
| クロック周波数 | 約98 kHz |
| モード | マスター |
| アドレス長 | 7ビット |

### 5.2 I2Cデバイスアドレス

| デバイス | アドレス（7bit） | 用途 |
|----------|-----------------|------|
| タッチパネル | 0x38（推定） | FT5x06タッチコントローラ |
| カメラ（OV5640） | 0x3C | カメラセンサー制御 |
| 温度センサー | 0x48（推定） | 温度計測 |

---

## 6. タイマー（GPT）設定

### 6.1 GPT0（LEDバックライト）

| 項目 | 値 |
|------|-----|
| チャネル | GPT0 |
| モード | PWM |
| 出力ピン | P109 (GTIOC0A) |
| 周波数 | 可変（輝度制御） |
| 用途 | LCDバックライト制御 |

### 6.2 GPT2（LED制御）

| 項目 | 値 |
|------|-----|
| チャネル | GPT2 |
| モード | PWM |
| 出力ピン | P113 (GTIOC2A) |
| 用途 | ステータスLED制御 |

### 6.3 GPT5（カメラXCLK）

| 項目 | 値 |
|------|-----|
| チャネル | GPT5 |
| モード | PWM |
| 出力ピン | P812 (GTIOC5A) |
| **周波数** | **24 MHz** |
| **Duty** | **50%** |
| 用途 | OV5640カメラクロック供給 |

### 6.4 GPT6（PWM出力）

| 項目 | 値 |
|------|-----|
| チャネル | GPT6 |
| モード | PWM |
| 出力ピン | P905 (GTIOC6A) |
| 用途 | 汎用PWM出力 |

---

## 7. ADC設定

### 7.1 ADC0チャネル

| チャネル | ピン | 用途 |
|----------|------|------|
| AN000 | P006 | 温度センサー入力 |
| AN001 | P014 | 汎用アナログ入力 |

### 7.2 ADC設定パラメータ

| 項目 | 値 |
|------|-----|
| 分解能 | 12ビット |
| 変換トリガ | ソフトウェアトリガ |
| サンプリング | シングルスキャン |
| 基準電圧 | AVCC (3.3V) |

---

## 8. 外部割込み設定

### 8.1 IRQ設定一覧

| IRQ | ピン | トリガ | 用途 |
|-----|------|--------|------|
| IRQ12 | P504 | 立ち下がりエッジ | SW1ボタン |
| IRQ13 | P610 | 立ち下がりエッジ | SW2ボタン |
| IRQ19 | P506 | 立ち下がりエッジ | タッチパネル割込み |
| IRQ15 | P905 | 立ち下がりエッジ | 汎用外部割込み |

### 8.2 IRQ優先度

| IRQ | 優先度 | 説明 |
|-----|--------|------|
| IRQ19（タッチ） | 高 | 即座に応答が必要 |
| IRQ12, IRQ13（ボタン） | 中 | ユーザー入力処理 |

---

## 9. SDRAM設定

### 9.1 SDRAMパラメータ

| 項目 | 値 |
|------|-----|
| 容量 | 128 MB |
| データバス幅 | 16ビット |
| アドレス範囲 | 0x68000000 - 0x6FFFFFFF |
| バスクロック | 200 MHz |
| CASレイテンシ | 3 |

### 9.2 SDRAM用途

| 用途 | サイズ | 説明 |
|------|--------|------|
| フレームバッファ | 約7.5 MB | 1024×600×4×2面 |
| カメラバッファ | 約4 MB | キャプチャ用 |
| 汎用領域 | 残り | アプリケーション用 |

---

## 10. 設定ファイル一覧

| ファイル | 内容 |
|----------|------|
| `ra_cfg/fsp_cfg/bsp/bsp_clock_cfg.h` | クロック設定 |
| `ra_cfg/fsp_cfg/bsp/bsp_pin_cfg.h` | ピン設定（参照） |
| `ra_gen/pin_data.c` | ピン初期化データ |
| `ra_gen/hal_data.c` | ペリフェラルインスタンス |
| `ra_cfg/fsp_cfg/r_glcdc_cfg.h` | GLCDC設定 |
| `ra_cfg/fsp_cfg/r_gpt_cfg.h` | GPT設定 |
| `ra_cfg/fsp_cfg/r_iic_master_cfg.h` | I2C設定 |
| `ra_cfg/fsp_cfg/r_icu_cfg.h` | 外部割込み設定 |

---

## 11. ハードウェア構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                        EK-RA8P1 ボード                               │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    RA8P1 MCU (Cortex-M85 @ 1GHz)              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │  │
│  │  │    PLL1     │  │    PLL2     │  │   Flash     │           │  │
│  │  │  2000 MHz   │  │   576 MHz   │  │    1 MB     │           │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │  │
│  │  │   GLCDC     │  │  MIPI-CSI   │  │    CEU      │           │  │
│  │  │ 1024×600    │  │  2-lane     │  │  Capture    │           │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘           │  │
│  └─────────│────────────────│────────────────│───────────────────┘  │
│            │                │                │                       │
│  ┌─────────▼──────┐  ┌──────▼───────┐  ┌─────▼───────┐             │
│  │  LCD Panel     │  │   OV5640     │  │   SDRAM     │             │
│  │  (7" 1024×600) │  │   Camera     │  │   128 MB    │             │
│  └────────────────┘  └──────────────┘  └─────────────┘             │
│                                                                      │
│  ┌────────────────┐  ┌──────────────┐  ┌─────────────┐             │
│  │  Touch Panel   │  │   SW1/SW2    │  │    LEDs     │             │
│  │  (I2C: 0x38)   │  │   Buttons    │  │   (PWM)     │             │
│  └────────────────┘  └──────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 12. 発見事項

### 12.1 設計の良い点

- **高速クロック構成**: 1GHz CPUで高性能処理が可能
- **効率的なメモリ構成**: 内蔵RAM + 大容量SDRAMの組み合わせ
- **柔軟なPWM制御**: 複数GPTチャネルでLED/バックライト制御
- **標準的なカメラI/F**: MIPI-CSI2による高速データ転送

### 12.2 注意点

- **クロック依存関係**: PLL設定変更時は全ペリフェラルへの影響を考慮
- **SDRAM初期化**: 起動シーケンスでの正確なタイミングが必要
- **I2Cアドレス競合**: 複数デバイス使用時はアドレス確認が必要

### 12.3 最適化の余地

- GPT5のカメラクロックは200MHzクロックから生成（24MHz）
- GLCDC割込みとDMA連携でCPU負荷軽減可能
- I2Cクロックは高速モード（400kHz）への変更が可能

---

## 関連ファイル

- `_quickstart/quickstart_ek_ra8p1_ep/e2studio/ra_cfg/fsp_cfg/bsp/bsp_clock_cfg.h` - クロック設定
- `_quickstart/quickstart_ek_ra8p1_ep/e2studio/ra_gen/pin_data.c` - ピン設定
- `_quickstart/quickstart_ek_ra8p1_ep/e2studio/ra_gen/hal_data.c` - HALデータ
- `_quickstart/quickstart_ek_ra8p1_ep/e2studio/ra_cfg/fsp_cfg/r_glcdc_cfg.h` - GLCDC設定
- `_quickstart/quickstart_ek_ra8p1_ep/e2studio/ra_cfg/fsp_cfg/r_gpt_cfg.h` - GPT設定

---

## 次のPhaseへの申し送り

### Phase 8（ペリフェラルドライバ解析）への情報

- クロック: CPU 1GHz, ペリフェラル 100-200MHz
- 主要ペリフェラル: GLCDC, MIPI-CSI, CEU, I2C, GPT, ADC
- 外部デバイス: LCD (1024×600), OV5640カメラ, タッチパネル
- メモリ: 内蔵Flash 1MB, SDRAM 128MB
- 割込み: IRQ12/13（ボタン）, IRQ19（タッチ）が主要
