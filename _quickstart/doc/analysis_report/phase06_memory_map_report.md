# Phase 6: メモリマップ解析 - 解析レポート

## 解析日時
2026-01-24

## 概要

EK-RA8P1 クイックスタートプロジェクトのリンカスクリプトを解析し、メモリマップとセクション配置を明確にしました。
本プロジェクトは内蔵フラッシュ、RAM、外部SDRAM、OSPIフラッシュを活用したグラフィックス重視のアプリケーションです。

---

## 1. メモリ領域の定義

### 1.1 メモリ領域一覧

| 領域名 | 開始アドレス | サイズ | 属性 | 用途 |
|--------|-------------|--------|------|------|
| **ITCM** | 0x00000000 | 128KB | rwx | 命令TCM（高速実行） |
| **DTCM** | 0x20000000 | 128KB | rwx | データTCM（高速アクセス） |
| **RAM** | 0x22000000 | 1.82MB | rwx | メインRAM |
| **DATA_FLASH** | 0x27000000 | 0 | rx | データフラッシュ（未使用） |
| **FLASH** | 0x02000000 | 1MB | rx | 内蔵フラッシュ |
| **SDRAM** | 0x68000000 | 128MB | rwx | 外部SDRAM |
| **OSPI1_CS0** | 0x70000000 | 128MB | rwx | OSPI1チップセレクト0 |
| **OSPI1_CS1** | 0x78000000 | 128MB | rx | OSPI1チップセレクト1 |
| **OSPI0_CS0** | 0x80000000 | 256MB | rwx | OSPI0チップセレクト0 |
| **OSPI0_CS1** | 0x90000000 | 256MB | rx | OSPI0チップセレクト1 |

### 1.2 メモリマップ図

```
アドレス              サイズ      領域名              用途
────────────────────────────────────────────────────────────────
0x00000000 ┬───────────────────────────────────────────────────
           │   128 KB      ITCM                命令TCM（高速実行）
0x0001FFFF ┴───────────────────────────────────────────────────

0x02000000 ┬───────────────────────────────────────────────────
           │   1 MB        FLASH               内蔵フラッシュ（コード）
0x020FFFFF ┴───────────────────────────────────────────────────

0x20000000 ┬───────────────────────────────────────────────────
           │   128 KB      DTCM                データTCM（高速データ）
0x2001FFFF ┴───────────────────────────────────────────────────

0x22000000 ┬───────────────────────────────────────────────────
           │   1.82 MB     RAM                 メインRAM
0x221D3FFF ┴───────────────────────────────────────────────────

0x68000000 ┬───────────────────────────────────────────────────
           │   128 MB      SDRAM               外部SDRAM（フレームバッファ）
0x6FFFFFFF ┴───────────────────────────────────────────────────

0x70000000 ┬───────────────────────────────────────────────────
           │   128 MB      OSPI1_CS0           外部シリアルフラッシュ1
0x77FFFFFF ┴───────────────────────────────────────────────────

0x80000000 ┬───────────────────────────────────────────────────
           │   256 MB      OSPI0_CS0           外部シリアルフラッシュ0
0x8FFFFFFF ┴───────────────────────────────────────────────────

0x90000000 ┬───────────────────────────────────────────────────
           │   256 MB      OSPI0_CS1           外部シリアルフラッシュ0-CS1
0x9FFFFFFF ┴───────────────────────────────────────────────────
```

---

## 2. フラッシュメモリ配置（0x02000000）

### 2.1 フラッシュセクション配置

| セクション | VMA | LMA | サイズ | 内容 |
|-----------|-----|-----|--------|------|
| `.fixed_vectors` | 0x02000000 | 0x02000000 | 64B | 固定ベクタテーブル |
| `.application_vectors` | 0x02000040 | 0x02000040 | 172B | アプリケーションベクタ |
| `.text` | 0x02003BD8 | 0x02003BD8 | ~824KB | プログラムコード |
| `.rodata` | (embedded) | (embedded) | - | 読み取り専用データ |
| `.init_array` | (embedded) | (embedded) | - | C++初期化配列 |
| `.fini_array` | (embedded) | (embedded) | - | C++終了配列 |
| `.ARM.exidx` | (embedded) | (embedded) | - | 例外アンワインド情報 |

### 2.2 フラッシュ使用量

```
┌─────────────────────────────────────────────────────┐
│ FLASH (1MB = 0x100000)                              │
├─────────────────────────────────────────────────────┤
│ ████████████████████████████████████░░░░░░░░░░░░░░ │
│ 使用: ~824KB (82%)         空き: ~176KB (18%)      │
└─────────────────────────────────────────────────────┘
```

---

## 3. RAM配置（0x22000000）

### 3.1 RAMセクション配置

| セクション | アドレス | サイズ | 内容 |
|-----------|----------|--------|------|
| DTC Vector Table | 0x22000000 | - | DMAチャネル転送用 |
| `.data` | 0x22000000 | ~15KB | 初期化済みデータ |
| Non-cached RAM | 0x22003AE8 | 24B | 非キャッシュ領域 |
| `.heap` (FreeRTOS) | 0x22003B00 | 512KB | FreeRTOSヒープ |
| `.stack` | 0x22003D00 | 1KB | メインスタック |
| `.bss` | 0x2200412C | ~600KB | 未初期化データ |
| Thread Stacks | 0x22097860 | ~25KB | タスクスタック |

### 3.2 タスクスタック詳細

| タスク | サイズ | 用途 |
|--------|--------|------|
| blinky_thread | 512B | LED点滅 |
| board_mon_thread | 1KB | ボード監視 |
| tp_thread | 4KB | タッチパネル |
| display_thread | 2KB | ディスプレイ |
| main_menu_thread | 8KB | メインメニュー |
| camera_thread | 10KB | カメラ処理 |

### 3.3 RAM使用量

```
┌─────────────────────────────────────────────────────┐
│ RAM (1.82MB = 0x1D4000)                             │
├─────────────────────────────────────────────────────┤
│ ██████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
│ 使用: ~657KB (36%)         空き: ~1.16MB (64%)     │
└─────────────────────────────────────────────────────┘
```

---

## 4. SDRAM配置（0x68000000）

### 4.1 SDRAMセクション配置

| セクション | アドレス | サイズ | 内容 |
|-----------|----------|--------|------|
| `vin_image_buffer_1` | 0x68000000 | 614KB | カメラ入力バッファ1 |
| `vin_image_buffer_2` | 0x680A8C00 | 614KB | カメラ入力バッファ2 |
| `vin_image_buffer_3` | 0x68151800 | 614KB | カメラ入力バッファ3 |
| `fb_background` | 0x681FA400 | 614KB | 背景フレームバッファ |
| `fb_foreground` | 0x682A3000 | 2.34MB | 前景フレームバッファ |
| `sdram_buffer` | 0x684FB000 | 2.34MB | ディスプレイバッファ |
| `user_clean_background` | 0x68753000 | 2.34MB | ユーザー背景画像 |
| `SDRAM_pixel_data` | 0x689AB040 | 7.05MB | ピクセルデータ |

### 4.2 フレームバッファ構成

```
┌─────────────────────────────────────────────────────┐
│              SDRAM Layout (0x68000000)              │
├─────────────────────────────────────────────────────┤
│  Camera Input Buffers (3x 640x480x2 = ~1.8MB)       │
│  ┌─────────┬─────────┬─────────┐                    │
│  │Buffer 1 │Buffer 2 │Buffer 3 │                    │
│  └─────────┴─────────┴─────────┘                    │
├─────────────────────────────────────────────────────┤
│  Display Framebuffers (1024x600 pixels)             │
│  ┌───────────────────────────────────────┐          │
│  │ Background Layer (Layer 0)            │          │
│  └───────────────────────────────────────┘          │
│  ┌───────────────────────────────────────┐          │
│  │ Foreground Layer (Layer 1)            │          │
│  └───────────────────────────────────────┘          │
├─────────────────────────────────────────────────────┤
│  Image Data & Working Buffers                       │
│  - sdram_buffer                                     │
│  - user_clean_background                            │
│  - SDRAM_pixel_data                                 │
└─────────────────────────────────────────────────────┘
```

---

## 5. OSPI0_CS1配置（0x90000000）

### 5.1 画像データ配置

| セクション | アドレス | サイズ | 内容 |
|-----------|----------|--------|------|
| LED背景画像 | 0x90000000 | ~2.4MB | `g_ref_001_user_led_background_1024x600` |
| ウェルカム画像 | 0x90258040 | ~2.4MB | `g_ref_000_welcome_screen_1024x600` |

### 5.2 OSPI使用量

```
┌─────────────────────────────────────────────────────┐
│ OSPI0_CS1 (256MB)                                   │
├─────────────────────────────────────────────────────┤
│ ██░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
│ 使用: ~4.8MB (<2%)         空き: ~251MB (98%)      │
└─────────────────────────────────────────────────────┘
```

---

## 6. 特殊なセクション

### 6.1 非キャッシュ領域

| 領域 | アドレス | サイズ | 用途 |
|------|----------|--------|------|
| RAM非キャッシュ | 0x22003AE8 | 24B | DMAバッファ |
| SDRAM非キャッシュ | (動的) | - | グラフィックスDMA |

### 6.2 DMAバッファ

- カメラ入力バッファ（VIN）：3バッファ構成
- フレームバッファ：ダブルバッファリング対応
- すべて32バイト境界アライメント

### 6.3 フレームバッファ詳細

| バッファ | 解像度 | ピクセル形式 | サイズ |
|----------|--------|--------------|--------|
| 背景 | 1024x600 | RGB565 | 1.17MB |
| 前景 | 1024x600 | RGB565 | 1.17MB |
| カメラ | 640x480 | RGB565 | 614KB×3 |

---

## 7. メモリ使用量サマリー

| 領域 | 総容量 | 使用量 | 空き | 使用率 |
|------|--------|--------|------|--------|
| **FLASH** | 1MB | 824KB | 176KB | 82% |
| **RAM** | 1.82MB | 657KB | 1.16MB | 36% |
| **ITCM** | 128KB | ~0 | 128KB | <1% |
| **DTCM** | 128KB | ~0 | 128KB | <1% |
| **SDRAM** | 128MB | ~18MB | ~110MB | 14% |
| **OSPI0_CS1** | 256MB | 4.8MB | 251MB | <2% |

---

## 8. リンカスクリプト構成

### 8.1 ファイル構成

```
script/fsp.ld              # メインリンカスクリプト
  ├── INCLUDE memory_regions.ld   # メモリ領域定義（Debug/に生成）
  └── INCLUDE fsp_gen.ld          # セクション配置（Debug/に生成）
```

### 8.2 memory_regions.ld の内容

```ld
RAM_START = 0x22000000;
RAM_LENGTH = 0x001d4000;
FLASH_START = 0x02000000;
FLASH_LENGTH = 0x00100000;
SDRAM_START = 0x68000000;
SDRAM_LENGTH = 0x08000000;
OSPI0_CS0_START = 0x80000000;
OSPI0_CS0_LENGTH = 0x10000000;
OSPI0_CS1_START = 0x90000000;
OSPI0_CS1_LENGTH = 0x10000000;
OSPI1_CS0_START = 0x70000000;
OSPI1_CS0_LENGTH = 0x08000000;
OSPI1_CS1_START = 0x78000000;
OSPI1_CS1_LENGTH = 0x08000000;
ITCM_START = 0x00000000;
ITCM_LENGTH = 0x00020000;
DTCM_START = 0x20000000;
DTCM_LENGTH = 0x00020000;
```

---

## 9. mapファイルの読み方

### 9.1 セクションサイズの確認

```bash
arm-none-eabi-size --format=berkeley quickstart_ek_ra8p1_ep.elf
```

出力例：
```
   text    data     bss     dec     hex filename
 844232   15080  605640 1464952  165a78 quickstart_ek_ra8p1_ep.elf
```

### 9.2 メモリ使用率の計算

```
FLASH使用率 = (text + data) / FLASH_LENGTH × 100
           = (844232 + 15080) / 1048576 × 100
           = 82%

RAM使用率 = (data + bss) / RAM_LENGTH × 100
          = (15080 + 605640) / 1912832 × 100
          = 32%
```

---

## 発見事項

### 1. グラフィックス重視の設計

- SDRAM: フレームバッファ、カメラバッファに大量使用
- 1024x600 LCD用のダブルバッファリング
- 640x480カメラ入力用トリプルバッファリング

### 2. 外部メモリの活用

- 大きな画像データはOSPI0_CS1に配置
- SDRAMはリアルタイムグラフィックス用
- 内蔵RAMはシステム/RTOS用

### 3. TCMの未活用

- ITCM/DTCMはほぼ未使用
- 高速処理が必要な場合に活用可能

### 4. メモリ余裕

- RAM: 64%空き
- OSPI: 98%空き
- 追加機能の実装余地あり

---

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `script/fsp.ld` | メインリンカスクリプト |
| `Debug/memory_regions.ld` | メモリ領域定義（自動生成） |
| `Debug/fsp_gen.ld` | セクション配置（自動生成） |
| `Debug/quickstart_ek_ra8p1_ep.map` | リンカマップファイル |

---

## 次のPhaseへの申し送り

### Phase 7（周辺機能解析）への情報

- フレームバッファはSDRAM 0x681FA400から配置
- カメラバッファはSDRAM 0x68000000から3バッファ
- 画像リソースはOSPI0_CS1に格納
- DMAアクセスには非キャッシュ領域を使用
